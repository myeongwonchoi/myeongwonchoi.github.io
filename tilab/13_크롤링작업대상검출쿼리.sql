USE CP_TILAB_NEW

/*
 1. TEST 진행할 vPOI_I_COMMON_ALL_BESSEL_240702 테이블 복사
*/
SELECT A.* INTO vPOI_I_COMMON_ALL_BESSEL_240702_2
FROM vPOI_I_COMMON_ALL_BESSEL_240702 A, POI_MAIN_ETC..[22y_2150_INDEX_220401] B
WHERE LEFT(A.TILE_ID,4) = B.MAP_ID
AND B.관할업체 = '티아이랩'

/*
 2. FNAME 확인 및 업데이트
*/
SELECT FNAME, REPLACE(FNAME, '/', '')
-- UPDATE vPOI_I_COMMON_ALL_BESSEL_240702_2 SET FNAME = REPLACE(FNAME, '/', '')
FROM vPOI_I_COMMON_ALL_BESSEL_240702_2

/*
 3. TEL 컬럼 추가 및 확인
*/
ALTER TABLE vPOI_I_COMMON_ALL_BESSEL_240702_2
ADD TEL VARCHAR(50);

SELECT TOP 10 * FROM vPOI_I_COMMON_ALL_BESSEL_240702_2

/*
 4. TEL 컬럼에 전화번호 입력
*/
UPDATE vPOI_I_COMMON_ALL_BESSEL_240702_2
SET TEL = COALESCE(TELE_A, '') + '-' + COALESCE(TELE_B, '') + '-' + COALESCE(TELE_C, '')

/*
 5. 기존에 전화번호가 NULL 값인 데이터들의 합을 삭제 (UPDATE 쿼리 전 확인 한번 해보는 습관)
*/
UPDATE vPOI_I_COMMON_ALL_BESSEL_240702_2
SET TEL = ''
-- SELECT TOP 10 * 
FROM vPOI_I_COMMON_ALL_BESSEL_240702_2
WHERE TEL = '--'

/*
 6. TEST 진행할 RAW_FRAN_240703 테이블 복사
*/
SELECT * INTO RAW_FRAN_240703_2
FROM RAW_FRAN_240703

/*
 7. 크롤링 테이블에 TEL 칼럼 추가
*/
ALTER TABLE RAW_FRAN_240703_2
ADD TEL VARCHAR(50);

SELECT TOP 10 * FROM RAW_FRAN_240703_2

/*
 8. 크롤링 테이블 내 TEL 칼럼에 RAW_TEL 데이터 업데이트
*/
UPDATE RAW_FRAN_240703_2 SET TEL = RAW_TEL
FROM RAW_FRAN_240703_2

/*
 9. 크롤링 테이블 내 TEL 칼럼에 전화번호 속성이 잘못 반영된 데이터 수정
*/
UPDATE RAW_FRAN_240703_2 SET TEL = REPLACE (TEL, ')','-')
-- SELECT TEL, REPLACE (TEL, ')','-')
FROM RAW_FRAN_240703_2
WHERE TEL LIKE '%)%'

/*
 10. 크롤링 테이블의 TEL과 vPOI_I_COMMON_ALL_BESSEL_240702_2의 TEL을 기준으로 join (join 시 항상 고유값하고만 조인)
*/
SELECT B.*
FROM vPOI_I_COMMON_ALL_BESSEL_240702_2 A, RAW_FRAN_240703_2 B
WHERE A.TEL = B.TEL
AND A.TEL <> ''
ORDER BY B.BNAME

/*
 11. 10번에서 검출되지 않은 대상을 검출 (크롤링_yymmdd 테이블에서 전화번호가 없거나 이상하게 반영되어서 join 실패한 대상 검출)
*/
SELECT *
FROM RAW_FRAN_240703_2
WHERE TEL NOT IN 
(
SELECT B.TEL
FROM vPOI_I_COMMON_ALL_BESSEL_240702_2 A, RAW_FRAN_240703_2 B
WHERE A.TEL = B.TEL
AND A.TEL <> ''
)
ORDER BY BNAME


